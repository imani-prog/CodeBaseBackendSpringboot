# Hospital Module: Entity, Repository, Service, and Controller

This document explains the full Hospital stack implemented in this project: data model, repository access, service behaviors, and REST controller endpoints with validation, errors, and example requests.

## Overview
- Package: `com.example.codebasebackend`
- Entity: `Entities.Hospital`
- Repository: `repositories.HospitalRepository`
- Service API: `services.HospitalService`
- Service Impl: `services.HospitalServiceImplementation`
- Controller: `controllers.HospitalController`
- Base path: `/api/hospitals`

## Data Model (Entities.Hospital)
Located at: `src/main/java/com/example/codebasebackend/Entities/Hospital.java`

Key fields and constraints:
- id: Long (PK, auto-generated, internal)
- code: String (immutable, unique business identifier generated by server like `HS001`; length ≤ 16)
- name: String (required, length ≤ 150)
- type: Enum HospitalType (required; default GENERAL)
- registrationNumber: String (required, unique, length ≤ 64)
- taxId: String (optional)
- email: String (optional, email format)
- mainPhone, altPhone, fax: String (optional, phone/fax pattern)
- website: String (optional)
- addressLine1, addressLine2: String (optional)
- city, state, country: String (optional)
- postalCode: String (optional)
- latitude, longitude: BigDecimal (optional, precision 9, scale 6)
- adminContactName, adminContactEmail, adminContactPhone: Optional; email/phone validatable
- numberOfBeds, numberOfIcuBeds, numberOfAmbulances: Integer (>= 0)
- servicesOffered, departments, operatingHours, acceptedInsurance, notes: text fields
- status: Enum HospitalStatus (required; default ACTIVE)
- patients: One-to-many lazy set of `Patient`
- createdAt, updatedAt: auto timestamps (@CreationTimestamp, @UpdateTimestamp)

Business code behavior (`code`):
- Generated after initial persist using the numeric id: `HS%03d` (e.g., id 1 -> HS001).
- Unique and immutable; client-provided `code` is ignored on create and not updatable.
- Appears in API responses for easier human-friendly references.

Enums:
- HospitalType: GENERAL, CLINIC, SPECIALTY, TEACHING, REHABILITATION, EMERGENCY_CENTER
- HospitalStatus: ACTIVE, INACTIVE, UNDER_MAINTENANCE, CLOSED

Indexes and constraints:
- Indexes on: name, city, email, registrationNumber, code
- Unique constraint: registrationNumber (and a column-level unique index on `code`)

Defaults via lifecycle hook:
- `@PrePersist` sets `status=ACTIVE` and `type=GENERAL` when missing.

## Repository (repositories.HospitalRepository)
Located at: `src/main/java/com/example/codebasebackend/repositories/HospitalRepository.java`

Extends `JpaRepository<Hospital, Long>` with convenience methods:
- `Optional<Hospital> findByRegistrationNumber(String registrationNumber)`
- `Optional<Hospital> findByCode(String code)`
- `List<Hospital> findByNameContainingIgnoreCase(String name)`
- `List<Hospital> findByCityIgnoreCase(String city)`
- `List<Hospital> findByStatus(Hospital.HospitalStatus status)`

## Service API (services.HospitalService)
Located at: `src/main/java/com/example/codebasebackend/services/HospitalService.java`

Contract:
- `Hospital createHospital(Hospital hospital)`
- `List<Hospital> listHospitals()`
- `Hospital getHospital(Long id)`
- `Hospital updateHospital(Long id, Hospital hospital)`
- `void deleteHospital(Long id)`

## Service Implementation (services.HospitalServiceImplementation)
Located at: `src/main/java/com/example/codebasebackend/services/HospitalServiceImplementation.java`

Annotations and transactional model:
- `@Service`, `@RequiredArgsConstructor`, `@Transactional`
- Read-only transactions for getters; default transactional for mutations.

Validation and business rules:
- Create
  - Requires a non-null payload; `id` is nulled to prevent injection.
  - Ignores any client-provided `code` and generates it post-persist as `HS%03d`.
  - Requires `registrationNumber` (non-blank) and enforces uniqueness.
  - Persists; entity-level validations (@NotBlank, @Email, @Min) are enforced by @Valid at the controller boundary.
- Get/list
  - `getHospital` requires non-null id, 404 when missing entity.
- Update
  - Requires non-null id and payload.
  - Re-checks `registrationNumber` uniqueness if provided (excluding current id).
  - Full update semantics: copies all mutable fields; server-managed `id`/`code` are never changed.
- Delete
  - Requires non-null id; 404 if entity does not exist, then `deleteById`.

Error handling:
- Uses `ResponseStatusException` with statuses:
  - 400 BAD_REQUEST: invalid/missing inputs, duplicate registrationNumber.
  - 404 NOT_FOUND: entity not found for id.

## Controller (controllers.HospitalController)
Located at: `src/main/java/com/example/codebasebackend/controllers/HospitalController.java`

Base path: `/api/hospitals`

Auditing:
- Methods are annotated with `@Auditable` (event types: READ, CREATE, UPDATE, DELETE), including entity id where applicable.

Endpoints:
- GET `/api/hospitals`
  - Returns 200 with `List<Hospital>`; each item includes `id` (internal), `code` (HS001…), and other fields.
- GET `/api/hospitals/{id}`
  - Returns 200 with `Hospital`; includes `code`; 404 if not found.
- POST `/api/hospitals`
  - Body: `Hospital` JSON (see sample below, omit `id` and `code`). Returns 200 with created entity including generated `id` and `code`. 400 on invalid input/duplicate registrationNumber.
- PUT `/api/hospitals/{id}`
  - Body: `Hospital` JSON; full update semantics. Server-managed `code` is preserved. Returns 200 with updated entity; 404 if not found; 400 on validation/uniqueness violations.
- DELETE `/api/hospitals/{id}`
  - Returns 204 No Content; 404 if not found.

## Sample Requests

Create a hospital (POST /api/hospitals)
```http
POST http://localhost:8080/api/hospitals
Content-Type: application/json

{
  "name": "City General Hospital",
  "type": "GENERAL",
  "registrationNumber": "REG-2025-0001",
  "taxId": "TIN-123456789",
  "email": "info@citygeneral.example",
  "mainPhone": "+254700000001",
  "altPhone": "+254700000002",
  "fax": "+254700000003",
  "website": "https://citygeneral.example",
  "addressLine1": "123 Main St",
  "addressLine2": "Block A",
  "city": "Nairobi",
  "state": "Nairobi",
  "postalCode": "00100",
  "country": "KE",
  "latitude": 1.2921,
  "longitude": 36.8219,
  "adminContactName": "Jane Doe",
  "adminContactEmail": "admin@citygeneral.example",
  "adminContactPhone": "+254700000004",
  "numberOfBeds": 250,
  "numberOfIcuBeds": 20,
  "numberOfAmbulances": 5,
  "servicesOffered": "radiology, surgery, labs",
  "departments": "cardiology, oncology, pediatrics",
  "operatingHours": "Mon-Sun 24/7",
  "acceptedInsurance": "NHIF, Private",
  "status": "ACTIVE",
  "notes": "Level 5 facility"
}
```

Sample create response (200 OK)
```json
{
  "id": 1,
  "code": "HS001",
  "name": "City General Hospital",
  "type": "GENERAL",
  "registrationNumber": "REG-2025-0001",
  "email": "info@citygeneral.example",
  "mainPhone": "+254700000001",
  "city": "Nairobi",
  "country": "KE",
  "status": "ACTIVE",
  "createdAt": "2025-08-23T23:19:23.000Z",
  "updatedAt": "2025-08-23T23:19:23.000Z"
  // ...other fields...
}
```

Update a hospital (PUT /api/hospitals/{id})
```http
PUT http://localhost:8080/api/hospitals/1
Content-Type: application/json

{
  "name": "City General Hospital - West",
  "type": "TEACHING",
  "registrationNumber": "REG-2025-0001",
  "taxId": "TIN-123456789",
  "email": "west@citygeneral.example",
  "mainPhone": "+254700000101",
  "altPhone": "+254700000102",
  "fax": "+254700000103",
  "website": "https://west.citygeneral.example",
  "addressLine1": "456 West Rd",
  "addressLine2": "Wing B",
  "city": "Nairobi",
  "state": "Nairobi",
  "postalCode": "00100",
  "country": "KE",
  "latitude": 1.295,
  "longitude": 36.82,
  "adminContactName": "John Smith",
  "adminContactEmail": "admin.west@citygeneral.example",
  "adminContactPhone": "+254700000104",
  "numberOfBeds": 300,
  "numberOfIcuBeds": 30,
  "numberOfAmbulances": 6,
  "servicesOffered": "radiology, surgery, labs, maternity",
  "departments": "cardiology, oncology, pediatrics, maternity",
  "operatingHours": "Mon-Sun 24/7",
  "acceptedInsurance": "NHIF, Private",
  "status": "ACTIVE",
  "notes": "Expanded capacity"
}
```

Fetch and list
```http
GET http://localhost:8080/api/hospitals
GET http://localhost:8080/api/hospitals/1
```

Delete
```http
DELETE http://localhost:8080/api/hospitals/1
```

## Migration note for existing data
With `spring.jpa.hibernate.ddl-auto=update`, the `code` column is added automatically. Existing rows will have `code = NULL` until updated/created via the service. To backfill existing data once, run:

```sql
UPDATE hospitals
SET code = 'HS' || LPAD(CAST(id AS TEXT), 3, '0')
WHERE code IS NULL;
```

## Error Scenarios and Responses
- 400 BAD_REQUEST
  - Missing payload or `id` path variable
  - Missing or blank `registrationNumber` on create
  - Duplicate `registrationNumber`
  - Violations of bean validation (@NotBlank, @Email, @Min, phone patterns)
- 404 NOT_FOUND
  - Hospital with given `id` doesn’t exist (get, update, delete)

## Relation to Patient
- `Hospital` has `@OneToMany(mappedBy = "hospital") Set<Patient> patients`.
- `Patient` optionally references a `Hospital` via `patient.hospital.id`.
  - When creating/updating a `Patient`:
    - If `hospital` or `hospital.id` is omitted/null, the association remains null (allowed).
    - If provided, the `Hospital` id must exist or a 400 error is thrown (handled in `PatientServiceImplementation`).

Example patient create referencing a hospital:
```http
POST http://localhost:8080/api/patients
Content-Type: application/json

{
  "firstName": "Alice",
  "lastName": "K",
  "gender": "FEMALE",
  "dateOfBirth": "1990-05-10",
  "email": "alice@example.com",
  "phone": "+254700000200",
  "city": "Nairobi",
  "country": "KE",
  "bloodType": "A_POS",
  "status": "ACTIVE",
  "hospital": { "id": 1 }
}
```

Or create without a hospital (association optional):
```http
POST http://localhost:8080/api/patients
Content-Type: application/json

{
  "firstName": "Bob",
  "lastName": "M",
  "gender": "MALE",
  "dateOfBirth": "1988-02-20",
  "email": "bob@example.com",
  "phone": "+254700000201",
  "city": "Nairobi",
  "country": "KE",
  "bloodType": "O_POS",
  "status": "ACTIVE"
}
```

## Auditing
All controller methods are annotated with `@Auditable` to record:
- Event types: READ, CREATE, UPDATE, DELETE
- Entity type: "Hospital"
- Entity id (where applicable)
- Optionally request args and result snapshot

See: `configs.AuditAspect` and `Entities.AuditLog` for implementation details.

## Build and Run (quick reference)
- Build: `./mvnw -DskipTests package`
- Run app: `./mvnw spring-boot:run`
- Base URL: `http://localhost:8080`

If the build complains about JAVA_HOME, set it appropriately, e.g. on Linux:
```bash
export JAVA_HOME=$(dirname $(dirname $(readlink -f $(which javac))))
export PATH="$JAVA_HOME/bin:$PATH"
```

## Future Enhancements
- Add filters to GET `/api/hospitals` (e.g., by `status`, `city`, `q` for name search) leveraging existing repository methods.
- Introduce DTOs for requests/responses and include `code` prominently for user-facing identifiers.
- Pagination and sorting for listing endpoints.
- Add partial update (PATCH) for targeted field updates.
- Optional: add `GET /api/hospitals/by-code/{code}` to fetch by business code.
